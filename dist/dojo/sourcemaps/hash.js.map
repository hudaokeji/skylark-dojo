{"version":3,"sources":["hash.js"],"names":["define","dojo","require","config","aspect","lang","topic","domReady","has","hash","replace","arguments","length","charAt","substring","_replace","location","href","_getHash","_recentHash","_ieUriMonitor","_connect","_pollFrequency","hashPollFrequency","_getSegment","str","delimiter","i","indexOf","_dispatchEvent","publish","_pollLocation","isTransitioning","setTimeout","hitch","iframe","index","global","document","compatMode","after","addEventListener","setInterval","attachEvent","ifr","createElement","ifrSrc","dojoBlankHtmlUrl","toUrl","useXDomain","console","warn","id","src","style","display","body","appendChild","this","recentIframeQuery","transitioning","expectedIFrameQuery","docTitle","ifrOffline","iframeLoc","resetState","pollLocation","iframeSearch","title","e","error","search"],"mappings":"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","file":"../hash.js","sourcesContent":["define([\"./_base/kernel\", \"require\", \"./_base/config\", \"./aspect\", \"./_base/lang\", \"./topic\", \"./domReady\", \"./sniff\"],\r\n\tfunction(dojo, require, config, aspect, lang, topic, domReady, has){\r\n\r\n\t// module:\r\n\t//\t\tdojo/hash\r\n\r\n\tdojo.hash = function(/* String? */ hash, /* Boolean? */ replace){\r\n\t\t// summary:\r\n\t\t//\t\tGets or sets the hash string in the browser URL.\r\n\t\t// description:\r\n\t\t//\t\tHandles getting and setting of location.hash.\r\n\t\t//\r\n\t\t//\t\t - If no arguments are passed, acts as a getter.\r\n\t\t//\t\t - If a string is passed, acts as a setter.\r\n\t\t// hash:\r\n\t\t//\t\tthe hash is set - #string.\r\n\t\t// replace:\r\n\t\t//\t\tIf true, updates the hash value in the current history\r\n\t\t//\t\tstate instead of creating a new history state.\r\n\t\t// returns:\r\n\t\t//\t\twhen used as a getter, returns the current hash string.\r\n\t\t//\t\twhen used as a setter, returns the new hash string.\r\n\t\t// example:\r\n\t\t//\t|\ttopic.subscribe(\"/dojo/hashchange\", context, callback);\r\n\t\t//\t|\r\n\t\t//\t|\tfunction callback (hashValue){\r\n\t\t//\t|\t\t// do something based on the hash value.\r\n\t\t//\t|\t}\r\n\r\n\t\t// getter\r\n\t\tif(!arguments.length){\r\n\t\t\treturn _getHash();\r\n\t\t}\r\n\t\t// setter\r\n\t\tif(hash.charAt(0) == \"#\"){\r\n\t\t\thash = hash.substring(1);\r\n\t\t}\r\n\t\tif(replace){\r\n\t\t\t_replace(hash);\r\n\t\t}else{\r\n\t\t\tlocation.href = \"#\" + hash;\r\n\t\t}\r\n\t\treturn hash; // String\r\n\t};\r\n\r\n\t// Global vars\r\n\tvar _recentHash, _ieUriMonitor, _connect,\r\n\t\t_pollFrequency = config.hashPollFrequency || 100;\r\n\r\n\t//Internal functions\r\n\tfunction _getSegment(str, delimiter){\r\n\t\tvar i = str.indexOf(delimiter);\r\n\t\treturn (i >= 0) ? str.substring(i+1) : \"\";\r\n\t}\r\n\r\n\tfunction _getHash(){\r\n\t\treturn _getSegment(location.href, \"#\");\r\n\t}\r\n\r\n\tfunction _dispatchEvent(){\r\n\t\ttopic.publish(\"/dojo/hashchange\", _getHash());\r\n\t}\r\n\r\n\tfunction _pollLocation(){\r\n\t\tif(_getHash() === _recentHash){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t_recentHash = _getHash();\r\n\t\t_dispatchEvent();\r\n\t}\r\n\r\n\tfunction _replace(hash){\r\n\t\tif(_ieUriMonitor){\r\n\t\t\tif(_ieUriMonitor.isTransitioning()){\r\n\t\t\t\tsetTimeout(lang.hitch(null,_replace,hash), _pollFrequency);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar href = _ieUriMonitor.iframe.location.href;\r\n\t\t\tvar index = href.indexOf('?');\r\n\t\t\t// main frame will detect and update itself\r\n\t\t\t_ieUriMonitor.iframe.location.replace(href.substring(0, index) + \"?\" + hash);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tlocation.replace(\"#\"+hash);\r\n\t\t!_connect && _pollLocation();\r\n\t}\r\n\r\n\tfunction IEUriMonitor(){\r\n\t\t// summary:\r\n\t\t//\t\tDetermine if the browser's URI has changed or if the user has pressed the\r\n\t\t//\t\tback or forward button. If so, call _dispatchEvent.\r\n\t\t//\r\n\t\t// description:\r\n\t\t//\t\tIE doesn't add changes to the URI's hash into the history unless the hash\r\n\t\t//\t\tvalue corresponds to an actual named anchor in the document. To get around\r\n\t\t//\t\tthis IE difference, we use a background IFrame to maintain a back-forward\r\n\t\t//\t\thistory, by updating the IFrame's query string to correspond to the\r\n\t\t//\t\tvalue of the main browser location's hash value.\r\n\t\t//\r\n\t\t//\t\tE.g. if the value of the browser window's location changes to\r\n\t\t//\r\n\t\t//\t\t#action=someAction\r\n\t\t//\r\n\t\t//\t\t... then we'd update the IFrame's source to:\r\n\t\t//\r\n\t\t//\t\t?action=someAction\r\n\t\t//\r\n\t\t//\t\tThis design leads to a somewhat complex state machine, which is\r\n\t\t//\t\tdescribed below:\r\n\t\t//\r\n\t\t//\t\t####s1\r\n\t\t//\r\n\t\t//\t\tStable state - neither the window's location has changed nor\r\n\t\t//\t\thas the IFrame's location. Note that this is the 99.9% case, so\r\n\t\t//\t\twe optimize for it.\r\n\t\t//\r\n\t\t//\t\tTransitions: s1, s2, s3\r\n\t\t//\r\n\t\t//\t\t####s2\r\n\t\t//\r\n\t\t//\t\tWindow's location changed - when a user clicks a hyperlink or\r\n\t\t//\t\tcode programmatically changes the window's URI.\r\n\t\t//\r\n\t\t//\t\tTransitions: s4\r\n\t\t//\r\n\t\t//\t\t####s3\r\n\t\t//\r\n\t\t//\t\tIframe's location changed as a result of user pressing back or\r\n\t\t//\t\tforward - when the user presses back or forward, the location of\r\n\t\t//\t\tthe background's iframe changes to the previous or next value in\r\n\t\t//\t\tits history.\r\n\t\t//\r\n\t\t//\t\tTransitions: s1\r\n\t\t//\r\n\t\t//\t\t####s4\r\n\t\t//\r\n\t\t//\t\tIEUriMonitor has programmatically changed the location of the\r\n\t\t//\t\tbackground iframe, but it's location hasn't yet changed. In this\r\n\t\t//\t\tcase we do nothing because we need to wait for the iframe's\r\n\t\t//\t\tlocation to reflect its actual state.\r\n\t\t//\r\n\t\t//\t\tTransitions: s4, s5\r\n\t\t//\r\n\t\t//\t\t####s5\r\n\t\t//\r\n\t\t//\t\tIEUriMonitor has programmatically changed the location of the\r\n\t\t//\t\tbackground iframe, and the iframe's location has caught up with\r\n\t\t//\t\treality. In this case we need to transition to s1.\r\n\t\t//\r\n\t\t//\t\tTransitions: s1\r\n\t\t//\r\n\t\t//\t\tThe hashchange event is always dispatched on the transition back to s1.\r\n\r\n\r\n\t\t// create and append iframe\r\n\t\tvar ifr = document.createElement(\"iframe\"),\r\n\t\t\tIFRAME_ID = \"dojo-hash-iframe\",\r\n\t\t\tifrSrc = config.dojoBlankHtmlUrl || require.toUrl(\"./resources/blank.html\");\r\n\r\n\t\tif(config.useXDomain && !config.dojoBlankHtmlUrl){\r\n\t\t\tconsole.warn(\"dojo/hash: When using cross-domain Dojo builds,\"\r\n\t\t\t\t+ \" please save dojo/resources/blank.html to your domain and set djConfig.dojoBlankHtmlUrl\"\r\n\t\t\t\t+ \" to the path on your domain to blank.html\");\r\n\t\t}\r\n\r\n\t\tifr.id = IFRAME_ID;\r\n\t\tifr.src = ifrSrc + \"?\" + _getHash();\r\n\t\tifr.style.display = \"none\";\r\n\t\tdocument.body.appendChild(ifr);\r\n\r\n\t\tthis.iframe = dojo.global[IFRAME_ID];\r\n\t\tvar recentIframeQuery, transitioning, expectedIFrameQuery, docTitle, ifrOffline,\r\n\t\t\tiframeLoc = this.iframe.location;\r\n\r\n\t\tfunction resetState(){\r\n\t\t\t_recentHash = _getHash();\r\n\t\t\trecentIframeQuery = ifrOffline ? _recentHash : _getSegment(iframeLoc.href, \"?\");\r\n\t\t\ttransitioning = false;\r\n\t\t\texpectedIFrameQuery = null;\r\n\t\t}\r\n\r\n\t\tthis.isTransitioning = function(){\r\n\t\t\treturn transitioning;\r\n\t\t};\r\n\r\n\t\tthis.pollLocation = function(){\r\n\t\t\tif(!ifrOffline){\r\n\t\t\t\ttry{\r\n\t\t\t\t\t//see if we can access the iframe's location without a permission denied error\r\n\t\t\t\t\tvar iframeSearch = _getSegment(iframeLoc.href, \"?\");\r\n\t\t\t\t\t//good, the iframe is same origin (no thrown exception)\r\n\t\t\t\t\tif(document.title != docTitle){ //sync title of main window with title of iframe.\r\n\t\t\t\t\t\tdocTitle = this.iframe.document.title = document.title;\r\n\t\t\t\t\t}\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\t//permission denied - server cannot be reached.\r\n\t\t\t\t\tifrOffline = true;\r\n\t\t\t\t\tconsole.error(\"dojo/hash: Error adding history entry. Server unreachable.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tvar hash = _getHash();\r\n\t\t\tif(transitioning && _recentHash === hash){\r\n\t\t\t\t// we're in an iframe transition (s4 or s5)\r\n\t\t\t\tif(ifrOffline || iframeSearch === expectedIFrameQuery){\r\n\t\t\t\t\t// s5 (iframe caught up to main window or iframe offline), transition back to s1\r\n\t\t\t\t\tresetState();\r\n\t\t\t\t\t_dispatchEvent();\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// s4 (waiting for iframe to catch up to main window)\r\n\t\t\t\t\tsetTimeout(lang.hitch(this,this.pollLocation),0);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}else if(_recentHash === hash && (ifrOffline || recentIframeQuery === iframeSearch)){\r\n\t\t\t\t// we're in stable state (s1, iframe query == main window hash), do nothing\r\n\t\t\t}else{\r\n\t\t\t\t// the user has initiated a URL change somehow.\r\n\t\t\t\t// sync iframe query <-> main window hash\r\n\t\t\t\tif(_recentHash !== hash){\r\n\t\t\t\t\t// s2 (main window location changed), set iframe url and transition to s4\r\n\t\t\t\t\t_recentHash = hash;\r\n\t\t\t\t\ttransitioning = true;\r\n\t\t\t\t\texpectedIFrameQuery = hash;\r\n\t\t\t\t\tifr.src = ifrSrc + \"?\" + expectedIFrameQuery;\r\n\t\t\t\t\tifrOffline = false; //we're updating the iframe src - set offline to false so we can check again on next poll.\r\n\t\t\t\t\tsetTimeout(lang.hitch(this,this.pollLocation),0); //yielded transition to s4 while iframe reloads.\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}else if(!ifrOffline){\r\n\t\t\t\t\t// s3 (iframe location changed via back/forward button), set main window url and transition to s1.\r\n\t\t\t\t\tlocation.href = \"#\" + iframeLoc.search.substring(1);\r\n\t\t\t\t\tresetState();\r\n\t\t\t\t\t_dispatchEvent();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tsetTimeout(lang.hitch(this,this.pollLocation), _pollFrequency);\r\n\t\t};\r\n\t\tresetState(); // initialize state (transition to s1)\r\n\t\tsetTimeout(lang.hitch(this,this.pollLocation), _pollFrequency);\r\n\t}\r\n\tdomReady(function(){\r\n\t\tif(\"onhashchange\" in dojo.global && (!has(\"ie\") || (has(\"ie\") >= 8 && document.compatMode != \"BackCompat\"))){\t//need this IE browser test because \"onhashchange\" exists in IE8 in IE7 mode\r\n\t\t\t_connect = aspect.after(dojo.global,\"onhashchange\",_dispatchEvent, true);\r\n\t\t}else{\r\n\t\t\tif(document.addEventListener){ // Non-IE\r\n\t\t\t\t_recentHash = _getHash();\r\n\t\t\t\tsetInterval(_pollLocation, _pollFrequency); //Poll the window location for changes\r\n\t\t\t}else if(document.attachEvent){ // IE7-\r\n\t\t\t\t//Use hidden iframe in versions of IE that don't have onhashchange event\r\n\t\t\t\t_ieUriMonitor = new IEUriMonitor();\r\n\t\t\t}\r\n\t\t\t// else non-supported browser, do nothing.\r\n\t\t}\r\n\t});\r\n\r\n\treturn dojo.hash;\r\n\r\n});\r\n"]}