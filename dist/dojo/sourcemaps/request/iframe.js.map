{"version":3,"sources":["request/iframe.js"],"names":["define","module","require","watch","util","handlers","lang","ioQuery","query","has","dom","domConstruct","win","mid","id","replace","onload","isValid","response","this","isFulfilled","isReady","_finished","handleResponse","error","options","doc","iframe","_frame","handleAs","documentElement","tagName","toLowerCase","orphan","xmlText","innerText","text","trim","data","getElementsByTagName","value","e","reject","resolve","Error","last","_callNext","global","dfd","_currentDfd","formNode","byId","form","_tmpForm","toClean","_contentToClean","i","length","key","j","childNodes","childNode","name","destroy","_originalAction","setAttribute","_originalMethod","method","_originalTarget","target","_fireNextRequest","defaultOptions","url","returnDeferred","parseArgs","deepCreate","create","_iframeName","deferred","_calledNext","_legacy","_dfdQueue","push","promise","onloadstr","uri","frames","console","warn","toUrl","frame","place","body","iframeNode","contentDocument","iframes","document","contentWindow","setSrc","_iframe","src","location","log","_notifyStart","shift","canceled","isCanceled","queryStr","c2c","notify","indexOf","slice","mixin","queryToObject","style","position","top","left","parentNode","appendChild","createInput","type","x","val","isArray","actionNode","getAttributeNode","methodNode","targetNode","emit","cancel","submit","extra","objectToQuery","tmpUrl","addCommonMethods"],"mappings":"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","file":"../../request/iframe.js","sourcesContent":["define([\r\n\t'module',\r\n\t'require',\r\n\t'./watch',\r\n\t'./util',\r\n\t'./handlers',\r\n\t'../_base/lang',\r\n\t'../io-query',\r\n\t'../query',\r\n\t'../has',\r\n\t'../dom',\r\n\t'../dom-construct',\r\n\t'../_base/window',\r\n\t'../NodeList-dom'/*=====,\r\n\t'../request',\r\n\t'../_base/declare' =====*/\r\n], function(module, require, watch, util, handlers, lang, ioQuery, query, has, dom, domConstruct, win/*=====, NodeList, request, declare =====*/){\r\n\tvar mid = module.id.replace(/[\\/\\.\\-]/g, '_'),\r\n\t\tonload = mid + '_onload';\r\n\r\n\tif(!win.global[onload]){\r\n\t\twin.global[onload] = function(){\r\n\t\t\tvar dfd = iframe._currentDfd;\r\n\t\t\tif(!dfd){\r\n\t\t\t\tiframe._fireNextRequest();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tvar response = dfd.response,\r\n\t\t\t\toptions = response.options,\r\n\t\t\t\tformNode = dom.byId(options.form) || dfd._tmpForm;\r\n\r\n\t\t\tif(formNode){\r\n\t\t\t\t// remove all the hidden content inputs\r\n\t\t\t\tvar toClean = dfd._contentToClean;\r\n\t\t\t\tfor(var i=0; i<toClean.length; i++){\r\n\t\t\t\t\tvar key = toClean[i];\r\n\t\t\t\t\t//Need to cycle over all nodes since we may have added\r\n\t\t\t\t\t//an array value which means that more than one node could\r\n\t\t\t\t\t//have the same .name value.\r\n\t\t\t\t\tfor(var j=0; j<formNode.childNodes.length; j++){\r\n\t\t\t\t\t\tvar childNode = formNode.childNodes[j];\r\n\t\t\t\t\t\tif(childNode.name === key){\r\n\t\t\t\t\t\t\tdomConstruct.destroy(childNode);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// restore original action + target\r\n\t\t\t\tdfd._originalAction && formNode.setAttribute('action', dfd._originalAction);\r\n\t\t\t\tif(dfd._originalMethod){\r\n\t\t\t\t\tformNode.setAttribute('method', dfd._originalMethod);\r\n\t\t\t\t\tformNode.method = dfd._originalMethod;\r\n\t\t\t\t}\r\n\t\t\t\tif(dfd._originalTarget){\r\n\t\t\t\t\tformNode.setAttribute('target', dfd._originalTarget);\r\n\t\t\t\t\tformNode.target = dfd._originalTarget;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(dfd._tmpForm){\r\n\t\t\t\tdomConstruct.destroy(dfd._tmpForm);\r\n\t\t\t\tdelete dfd._tmpForm;\r\n\t\t\t}\r\n\r\n\t\t\tdfd._finished = true;\r\n\t\t};\r\n\t}\r\n\r\n\tfunction create(name, onloadstr, uri){\r\n\t\tif(win.global[name]){\r\n\t\t\treturn win.global[name];\r\n\t\t}\r\n\r\n\t\tif(win.global.frames[name]){\r\n\t\t\treturn win.global.frames[name];\r\n\t\t}\r\n\r\n\t\tif(!uri){\r\n\t\t\tif(has('config-useXDomain') && !has('config-dojoBlankHtmlUrl')){\r\n\t\t\t\tconsole.warn('dojo/request/iframe: When using cross-domain Dojo builds,' +\r\n\t\t\t\t\t' please save dojo/resources/blank.html to your domain and set dojoConfig.dojoBlankHtmlUrl' +\r\n\t\t\t\t\t' to the path on your domain to blank.html');\r\n\t\t\t}\r\n\t\t\turi = (has('config-dojoBlankHtmlUrl')||require.toUrl('dojo/resources/blank.html'));\r\n\t\t}\r\n\r\n\t\tvar frame = domConstruct.place(\r\n\t\t\t'<iframe id=\"'+name+'\" name=\"'+name+'\" src=\"'+uri+'\" onload=\"'+onloadstr+\r\n\t\t\t'\" style=\"position: absolute; left: 1px; top: 1px; height: 1px; width: 1px; visibility: hidden\">',\r\n\t\t\twin.body());\r\n\r\n\t\twin.global[name] = frame;\r\n\r\n\t\treturn frame;\r\n\t}\r\n\r\n\tfunction setSrc(_iframe, src, replace){\r\n\t\tvar frame = win.global.frames[_iframe.name];\r\n\r\n\t\tif(frame.contentWindow){\r\n\t\t\t// We have an iframe node instead of the window\r\n\t\t\tframe = frame.contentWindow;\r\n\t\t}\r\n\r\n\t\ttry{\r\n\t\t\tif(!replace){\r\n\t\t\t\tframe.location = src;\r\n\t\t\t}else{\r\n\t\t\t\tframe.location.replace(src);\r\n\t\t\t}\r\n\t\t}catch(e){\r\n\t\t\tconsole.log('dojo/request/iframe.setSrc: ', e);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction doc(iframeNode){\r\n\t\tif(iframeNode.contentDocument){\r\n\t\t\treturn iframeNode.contentDocument;\r\n\t\t}\r\n\t\tvar name = iframeNode.name;\r\n\t\tif(name){\r\n\t\t\tvar iframes = win.doc.getElementsByTagName('iframe');\r\n\t\t\tif(iframeNode.document && iframes[name].contentWindow && iframes[name].contentWindow.document){\r\n\t\t\t\treturn iframes[name].contentWindow.document;\r\n\t\t\t}else if(win.doc.frames[name] && win.doc.frames[name].document){\r\n\t\t\t\treturn win.doc.frames[name].document;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tfunction createForm(){\r\n\t\treturn domConstruct.create('form', {\r\n\t\t\tname: mid + '_form',\r\n\t\t\tstyle: {\r\n\t\t\t\tposition: 'absolute',\r\n\t\t\t\ttop: '-1000px',\r\n\t\t\t\tleft: '-1000px'\r\n\t\t\t}\r\n\t\t}, win.body());\r\n\t}\r\n\r\n\tfunction fireNextRequest(){\r\n\t\t// summary:\r\n\t\t//\t\tInternal method used to fire the next request in the queue.\r\n\t\tvar dfd;\r\n\t\ttry{\r\n\t\t\tif(iframe._currentDfd || !iframe._dfdQueue.length){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tdo{\r\n\t\t\t\tdfd = iframe._currentDfd = iframe._dfdQueue.shift();\r\n\t\t\t}while(dfd && (dfd.canceled || (dfd.isCanceled && dfd.isCanceled())) && iframe._dfdQueue.length);\r\n\r\n\t\t\tif(!dfd || dfd.canceled || (dfd.isCanceled && dfd.isCanceled())){\r\n\t\t\t\tiframe._currentDfd = null;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tvar response = dfd.response,\r\n\t\t\t\toptions = response.options,\r\n\t\t\t\tc2c = dfd._contentToClean = [],\r\n\t\t\t\tformNode = dom.byId(options.form),\r\n\t\t\t\tnotify = util.notify,\r\n\t\t\t\tdata = options.data || null,\r\n\t\t\t\tqueryStr;\r\n\r\n\t\t\tif(!dfd._legacy && options.method === 'POST' && !formNode){\r\n\t\t\t\tformNode = dfd._tmpForm = createForm();\r\n\t\t\t}else if(options.method === 'GET' && formNode && response.url.indexOf('?') > -1){\r\n\t\t\t\tqueryStr = response.url.slice(response.url.indexOf('?') + 1);\r\n\t\t\t\tdata = lang.mixin(ioQuery.queryToObject(queryStr), data);\r\n\t\t\t}\r\n\r\n\t\t\tif(formNode){\r\n\t\t\t\tif(!dfd._legacy){\r\n\t\t\t\t\tvar parentNode = formNode;\r\n\t\t\t\t\tdo{\r\n\t\t\t\t\t\tparentNode = parentNode.parentNode;\r\n\t\t\t\t\t}while(parentNode && parentNode !== win.doc.documentElement);\r\n\r\n\t\t\t\t\t// Append the form node or some browsers won't work\r\n\t\t\t\t\tif(!parentNode){\r\n\t\t\t\t\t\tformNode.style.position = 'absolute';\r\n\t\t\t\t\t\tformNode.style.left = '-1000px';\r\n\t\t\t\t\t\tformNode.style.top = '-1000px';\r\n\t\t\t\t\t\twin.body().appendChild(formNode);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif(!formNode.name){\r\n\t\t\t\t\t\tformNode.name = mid + '_form';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// if we have things in data, we need to add them to the form\r\n\t\t\t\t// before submission\r\n\t\t\t\tif(data){\r\n\t\t\t\t\tvar createInput = function(name, value){\r\n\t\t\t\t\t\tdomConstruct.create('input', {\r\n\t\t\t\t\t\t\ttype: 'hidden',\r\n\t\t\t\t\t\t\tname: name,\r\n\t\t\t\t\t\t\tvalue: value\r\n\t\t\t\t\t\t}, formNode);\r\n\t\t\t\t\t\tc2c.push(name);\r\n\t\t\t\t\t};\r\n\t\t\t\t\tfor(var x in data){\r\n\t\t\t\t\t\tvar val = data[x];\r\n\t\t\t\t\t\tif(lang.isArray(val) && val.length > 1){\r\n\t\t\t\t\t\t\tfor(var i=0; i<val.length; i++){\r\n\t\t\t\t\t\t\t\tcreateInput(x, val[i]);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tif(!formNode[x]){\r\n\t\t\t\t\t\t\t\tcreateInput(x, val);\r\n\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\tformNode[x].value = val;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//IE requires going through getAttributeNode instead of just getAttribute in some form cases,\r\n\t\t\t\t//so use it for all.  See #2844\r\n\t\t\t\tvar actionNode = formNode.getAttributeNode('action'),\r\n\t\t\t\t\tmethodNode = formNode.getAttributeNode('method'),\r\n\t\t\t\t\ttargetNode = formNode.getAttributeNode('target');\r\n\r\n\t\t\t\tif(response.url){\r\n\t\t\t\t\tdfd._originalAction = actionNode ? actionNode.value : null;\r\n\t\t\t\t\tif(actionNode){\r\n\t\t\t\t\t\tactionNode.value = response.url;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tformNode.setAttribute('action', response.url);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(!dfd._legacy){\r\n\t\t\t\t\tdfd._originalMethod = methodNode ? methodNode.value : null;\r\n\t\t\t\t\tif(methodNode){\r\n\t\t\t\t\t\tmethodNode.value = options.method;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tformNode.setAttribute('method', options.method);\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tif(!methodNode || !methodNode.value){\r\n\t\t\t\t\t\tif(methodNode){\r\n\t\t\t\t\t\t\tmethodNode.value = options.method;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tformNode.setAttribute('method', options.method);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdfd._originalTarget = targetNode ? targetNode.value : null;\r\n\t\t\t\tif(targetNode){\r\n\t\t\t\t\ttargetNode.value = iframe._iframeName;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tformNode.setAttribute('target', iframe._iframeName);\r\n\t\t\t\t}\r\n\t\t\t\tformNode.target = iframe._iframeName;\r\n\r\n\t\t\t\tnotify && notify.emit('send', response, dfd.promise.cancel);\r\n\t\t\t\tiframe._notifyStart(response);\r\n\t\t\t\tformNode.submit();\r\n\t\t\t}else{\r\n\t\t\t\t// otherwise we post a GET string by changing URL location for the\r\n\t\t\t\t// iframe\r\n\r\n\t\t\t\tvar extra = '';\r\n\t\t\t\tif(response.options.data){\r\n\t\t\t\t\textra = response.options.data;\r\n\t\t\t\t\tif(typeof extra !== 'string'){\r\n\t\t\t\t\t\textra = ioQuery.objectToQuery(extra);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tvar tmpUrl = response.url + (response.url.indexOf('?') > -1 ? '&' : '?') + extra;\r\n\t\t\t\tnotify && notify.emit('send', response, dfd.promise.cancel);\r\n\t\t\t\tiframe._notifyStart(response);\r\n\t\t\t\tiframe.setSrc(iframe._frame, tmpUrl, true);\r\n\t\t\t}\r\n\t\t}catch(e){\r\n\t\t\tdfd.reject(e);\r\n\t\t}\r\n\t}\r\n\r\n\t// dojo/request/watch handlers\r\n\tfunction isValid(response){\r\n\t\treturn !this.isFulfilled();\r\n\t}\r\n\tfunction isReady(response){\r\n\t\treturn !!this._finished;\r\n\t}\r\n\tfunction handleResponse(response, error){\r\n\t\tif(!error){\r\n\t\t\ttry{\r\n\t\t\t\tvar options = response.options,\r\n\t\t\t\t\tdoc = iframe.doc(iframe._frame),\r\n\t\t\t\t\thandleAs = options.handleAs;\r\n\r\n\t\t\t\tif(handleAs !== 'html'){\r\n\t\t\t\t\tif(handleAs === 'xml'){\r\n\t\t\t\t\t\t// IE6-8 have to parse the XML manually. See http://bugs.dojotoolkit.org/ticket/6334\r\n\t\t\t\t\t\tif(doc.documentElement.tagName.toLowerCase() === 'html'){\r\n\t\t\t\t\t\t\tquery('a', doc.documentElement).orphan();\r\n\t\t\t\t\t\t\tvar xmlText = doc.documentElement.innerText;\r\n\t\t\t\t\t\t\txmlText = xmlText.replace(/>\\s+</g, '><');\r\n\t\t\t\t\t\t\tresponse.text = lang.trim(xmlText);\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tresponse.data = doc;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t// 'json' and 'javascript' and 'text'\r\n\t\t\t\t\t\tresponse.text = doc.getElementsByTagName('textarea')[0].value; // text\r\n\t\t\t\t\t}\r\n\t\t\t\t\thandlers(response);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tresponse.data = doc;\r\n\t\t\t\t}\r\n\t\t\t}catch(e){\r\n\t\t\t\terror = e;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(error){\r\n\t\t\tthis.reject(error);\r\n\t\t}else if(this._finished){\r\n\t\t\tthis.resolve(response);\r\n\t\t}else{\r\n\t\t\tthis.reject(new Error('Invalid dojo/request/iframe request state'));\r\n\t\t}\r\n\t}\r\n\tfunction last(response){\r\n\t\tthis._callNext();\r\n\t}\r\n\r\n\tvar defaultOptions = {\r\n\t\tmethod: 'POST'\r\n\t};\r\n\tfunction iframe(url, options, returnDeferred){\r\n\t\tvar response = util.parseArgs(url, util.deepCreate(defaultOptions, options), true);\r\n\t\turl = response.url;\r\n\t\toptions = response.options;\r\n\r\n\t\tif(options.method !== 'GET' && options.method !== 'POST'){\r\n\t\t\tthrow new Error(options.method + ' not supported by dojo/request/iframe');\r\n\t\t}\r\n\r\n\t\tif(!iframe._frame){\r\n\t\t\tiframe._frame = iframe.create(iframe._iframeName, onload + '();');\r\n\t\t}\r\n\r\n\t\tvar dfd = util.deferred(response, null, isValid, isReady, handleResponse, last);\r\n\t\tdfd._callNext = function(){\r\n\t\t\tif(!this._calledNext){\r\n\t\t\t\tthis._calledNext = true;\r\n\t\t\t\tiframe._currentDfd = null;\r\n\t\t\t\tiframe._fireNextRequest();\r\n\t\t\t}\r\n\t\t};\r\n\t\tdfd._legacy = returnDeferred;\r\n\r\n\t\tiframe._dfdQueue.push(dfd);\r\n\t\tiframe._fireNextRequest();\r\n\r\n\t\twatch(dfd);\r\n\r\n\t\treturn returnDeferred ? dfd : dfd.promise;\r\n\t}\r\n\r\n\t/*=====\r\n\tiframe = function(url, options){\r\n\t\t// summary:\r\n\t\t//\t\tSends a request using an iframe element with the given URL and options.\r\n\t\t// url: String\r\n\t\t//\t\tURL to request\r\n\t\t// options: dojo/request/iframe.__Options?\r\n\t\t//\t\tOptions for the request.\r\n\t\t// returns: dojo/request.__Promise\r\n\t};\r\n\tiframe.__BaseOptions = declare(request.__BaseOptions, {\r\n\t\t// form: DOMNode?\r\n\t\t//\t\tA form node to use to submit data to the server.\r\n\t\t// data: String|Object?\r\n\t\t//\t\tData to transfer. When making a GET request, this will\r\n\t\t//\t\tbe converted to key=value parameters and appended to the\r\n\t\t//\t\tURL.\r\n\t});\r\n\tiframe.__MethodOptions = declare(null, {\r\n\t\t// method: String?\r\n\t\t//\t\tThe HTTP method to use to make the request. Must be\r\n\t\t//\t\tuppercase. Only `\"GET\"` and `\"POST\"` are accepted.\r\n\t\t//\t\tDefault is `\"POST\"`.\r\n\t});\r\n\tiframe.__Options = declare([iframe.__BaseOptions, iframe.__MethodOptions]);\r\n\r\n\tiframe.get = function(url, options){\r\n\t\t// summary:\r\n\t\t//\t\tSend an HTTP GET request using an iframe element with the given URL and options.\r\n\t\t// url: String\r\n\t\t//\t\tURL to request\r\n\t\t// options: dojo/request/iframe.__BaseOptions?\r\n\t\t//\t\tOptions for the request.\r\n\t\t// returns: dojo/request.__Promise\r\n\t};\r\n\tiframe.post = function(url, options){\r\n\t\t// summary:\r\n\t\t//\t\tSend an HTTP POST request using an iframe element with the given URL and options.\r\n\t\t// url: String\r\n\t\t//\t\tURL to request\r\n\t\t// options: dojo/request/iframe.__BaseOptions?\r\n\t\t//\t\tOptions for the request.\r\n\t\t// returns: dojo/request.__Promise\r\n\t};\r\n\t=====*/\r\n\tiframe.create = create;\r\n\tiframe.doc = doc;\r\n\tiframe.setSrc = setSrc;\r\n\r\n\t// TODO: Make these truly private in 2.0\r\n\tiframe._iframeName = mid + '_IoIframe';\r\n\tiframe._notifyStart = function(){};\r\n\tiframe._dfdQueue = [];\r\n\tiframe._currentDfd = null;\r\n\tiframe._fireNextRequest = fireNextRequest;\r\n\r\n\tutil.addCommonMethods(iframe, ['GET', 'POST']);\r\n\r\n\treturn iframe;\r\n});\r\n"]}