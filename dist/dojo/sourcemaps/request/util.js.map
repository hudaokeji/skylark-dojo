{"version":3,"sources":["request/util.js"],"names":["define","exports","RequestError","CancelError","Deferred","ioQuery","array","lang","Promise","deepCopy","target","source","name","tval","sval","deepCreate","properties","value","delegate","freeze","Object","obj","okHandler","response","dataHandler","data","text","deferred","cancel","isValid","isReady","handleResponse","last","def","reason","responsePromise","then","otherwise","error","notify","hitch","dataPromise","promise","prop","hasOwnProperty","call","addCommonMethods","provider","methods","forEach","method","toLowerCase","url","options","parseArgs","skipData","query","objectToQuery","preventCache","Date","indexOf","getHeader","headerName","checkStatus","stat"],"mappings":"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","file":"../../request/util.js","sourcesContent":["define([\r\n\t'exports',\r\n\t'../errors/RequestError',\r\n\t'../errors/CancelError',\r\n\t'../Deferred',\r\n\t'../io-query',\r\n\t'../_base/array',\r\n\t'../_base/lang',\r\n\t'../promise/Promise'\r\n], function(exports, RequestError, CancelError, Deferred, ioQuery, array, lang, Promise){\r\n\texports.deepCopy = function deepCopy(target, source){\r\n\t\tfor(var name in source){\r\n\t\t\tvar tval = target[name],\r\n\t\t\t\tsval = source[name];\r\n\t\t\tif(tval !== sval){\r\n\t\t\t\tif(tval && typeof tval === 'object' && sval && typeof sval === 'object'){\r\n\t\t\t\t\texports.deepCopy(tval, sval);\r\n\t\t\t\t}else{\r\n\t\t\t\t\ttarget[name] = sval;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn target;\r\n\t};\r\n\r\n\texports.deepCreate = function deepCreate(source, properties){\r\n\t\tproperties = properties || {};\r\n\t\tvar target = lang.delegate(source),\r\n\t\t\tname, value;\r\n\r\n\t\tfor(name in source){\r\n\t\t\tvalue = source[name];\r\n\r\n\t\t\tif(value && typeof value === 'object'){\r\n\t\t\t\ttarget[name] = exports.deepCreate(value, properties[name]);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn exports.deepCopy(target, properties);\r\n\t};\r\n\r\n\tvar freeze = Object.freeze || function(obj){ return obj; };\r\n\tfunction okHandler(response){\r\n\t\treturn freeze(response);\r\n\t}\r\n\tfunction dataHandler (response) {\r\n\t\treturn response.data || response.text;\r\n\t}\r\n\r\n\texports.deferred = function deferred(response, cancel, isValid, isReady, handleResponse, last){\r\n\t\tvar def = new Deferred(function(reason){\r\n\t\t\tcancel && cancel(def, response);\r\n\r\n\t\t\tif(!reason || !(reason instanceof RequestError) && !(reason instanceof CancelError)){\r\n\t\t\t\treturn new CancelError('Request canceled', response);\r\n\t\t\t}\r\n\t\t\treturn reason;\r\n\t\t});\r\n\r\n\t\tdef.response = response;\r\n\t\tdef.isValid = isValid;\r\n\t\tdef.isReady = isReady;\r\n\t\tdef.handleResponse = handleResponse;\r\n\r\n\t\tfunction errHandler(error){\r\n\t\t\terror.response = response;\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t\tvar responsePromise = def.then(okHandler).otherwise(errHandler);\r\n\r\n\t\tif(exports.notify){\r\n\t\t\tresponsePromise.then(\r\n\t\t\t\tlang.hitch(exports.notify, 'emit', 'load'),\r\n\t\t\t\tlang.hitch(exports.notify, 'emit', 'error')\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tvar dataPromise = responsePromise.then(dataHandler);\r\n\r\n\t\t// http://bugs.dojotoolkit.org/ticket/16794\r\n\t\t// The following works around a leak in IE9 through the\r\n\t\t// prototype using lang.delegate on dataPromise and\r\n\t\t// assigning the result a property with a reference to\r\n\t\t// responsePromise.\r\n\t\tvar promise = new Promise();\r\n\t\tfor (var prop in dataPromise) {\r\n\t\t\tif (dataPromise.hasOwnProperty(prop)) {\r\n\t\t\t\tpromise[prop] = dataPromise[prop];\r\n\t\t\t}\r\n\t\t}\r\n\t\tpromise.response = responsePromise;\r\n\t\tfreeze(promise);\r\n\t\t// End leak fix\r\n\r\n\r\n\t\tif(last){\r\n\t\t\tdef.then(function(response){\r\n\t\t\t\tlast.call(def, response);\r\n\t\t\t}, function(error){\r\n\t\t\t\tlast.call(def, response, error);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tdef.promise = promise;\r\n\t\tdef.then = promise.then;\r\n\r\n\t\treturn def;\r\n\t};\r\n\r\n\texports.addCommonMethods = function addCommonMethods(provider, methods){\r\n\t\tarray.forEach(methods||['GET', 'POST', 'PUT', 'DELETE'], function(method){\r\n\t\t\tprovider[(method === 'DELETE' ? 'DEL' : method).toLowerCase()] = function(url, options){\r\n\t\t\t\toptions = lang.delegate(options||{});\r\n\t\t\t\toptions.method = method;\r\n\t\t\t\treturn provider(url, options);\r\n\t\t\t};\r\n\t\t});\r\n\t};\r\n\r\n\texports.parseArgs = function parseArgs(url, options, skipData){\r\n\t\tvar data = options.data,\r\n\t\t\tquery = options.query;\r\n\t\t\r\n\t\tif(data && !skipData){\r\n\t\t\tif(typeof data === 'object'){\r\n\t\t\t\toptions.data = ioQuery.objectToQuery(data);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(query){\r\n\t\t\tif(typeof query === 'object'){\r\n\t\t\t\tquery = ioQuery.objectToQuery(query);\r\n\t\t\t}\r\n\t\t\tif(options.preventCache){\r\n\t\t\t\tquery += (query ? '&' : '') + 'request.preventCache=' + (+(new Date));\r\n\t\t\t}\r\n\t\t}else if(options.preventCache){\r\n\t\t\tquery = 'request.preventCache=' + (+(new Date));\r\n\t\t}\r\n\r\n\t\tif(url && query){\r\n\t\t\turl += (~url.indexOf('?') ? '&' : '?') + query;\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\turl: url,\r\n\t\t\toptions: options,\r\n\t\t\tgetHeader: function(headerName){ return null; }\r\n\t\t};\r\n\t};\r\n\r\n\texports.checkStatus = function(stat){\r\n\t\tstat = stat || 0;\r\n\t\treturn (stat >= 200 && stat < 300) || // allow any 2XX response code\r\n\t\t\tstat === 304 ||                 // or, get it out of the cache\r\n\t\t\tstat === 1223 ||                // or, Internet Explorer mangled the status code\r\n\t\t\t!stat;                         // or, we're Titanium/browser chrome/chrome extension requesting a local file\r\n\t};\r\n});\r\n"]}