{"version":3,"sources":["request/script.js"],"names":["define","module","watch","util","kernel","array","lang","on","dom","domConstruct","has","win","add","global","document","createElement","toString","mid","id","replace","counter","loadEvent","readyRegExp","callbacks","deadScripts","attach","url","frameDoc","doc","element","type","src","async","charset","getElementsByTagName","appendChild","remove","cleanup","destroy","byId","_addDeadScript","dfd","options","response","ioArgs","push","canceler","canDelete","script","_remove","isValid","length","forEach","_script","jsonp","data","isReadyScript","this","scriptLoaded","isReadyCheckString","checkString","eval","handleResponse","error","reject","resolve","returnDeferred","parseArgs","deepCopy","deferred","mixin","RegExp","test","indexOf","json","notify","emit","promise","cancel","canAttach","node","_attach","handle","evt","readyState","get","_callbacksProperty"],"mappings":";;;;;;;AAAAA,QACC,SACA,UACA,SACA,kBACA,iBACA,gBACA,QACA,SACA,mBACA,SACA,mBAGE,SAASC,OAAQC,MAAOC,KAAMC,OAAQC,MAAOC,KAAMC,GAAIC,IAAKC,aAAcC,IAAKC,KACjFD,IAAIE,IAAI,0BAA2B,SAASC,EAAQC,GAEnD,YAA+C,IADlCA,EAASC,cAAc,UACK,0BACZ,IAApBF,EAAc,OAAoD,mBAA/BA,EAAc,MAAEG,cAG7D,IAAIC,IAAMhB,OAAOiB,GAAGC,QAAQ,YAAa,KACxCC,QAAU,EACVC,UAAYX,IAAI,2BAA6B,mBAAqB,OAClEY,YAAc,kBACdC,UAAYnB,OAAOS,OAAOI,IAAM,iBAChCO,eAED,SAASC,OAAOP,EAAIQ,EAAKC,GACxB,IAAIC,EAAOD,GAAYhB,IAAIiB,IAC1BC,EAAUD,EAAIb,cAAc,UAQ7B,OANAc,EAAQC,KAAO,kBACfD,EAAQE,IAAML,EACdG,EAAQX,GAAKA,EACbW,EAAQG,OAAQ,EAChBH,EAAQI,QAAU,QAEXL,EAAIM,qBAAqB,QAAQ,GAAGC,YAAYN,GAGxD,SAASO,OAAOlB,EAAIS,EAAUU,GAC7B5B,aAAa6B,QAAQ9B,IAAI+B,KAAKrB,EAAIS,IAE/BJ,UAAUL,KACTmB,EAIFd,UAAUL,GAAM,kBACRK,UAAUL,WAGXK,UAAUL,IAKpB,SAASsB,eAAeC,GAGvB,IAAIC,EAAUD,EAAIE,SAASD,QAC1Bf,EAAWe,EAAQE,OAASF,EAAQE,OAAOjB,SAAWe,EAAQf,SAE/DH,YAAYqB,MAAO3B,GAAIuB,EAAIvB,GAAIS,SAAUA,IAEtCe,EAAQE,SACVF,EAAQE,OAAOjB,SAAW,MAE3Be,EAAQf,SAAW,KAGpB,SAASmB,SAASL,EAAKE,GACnBF,EAAIM,WAGNC,OAAOC,QAAQR,EAAIvB,GAAIyB,EAASD,QAAQf,UAAU,GAGpD,SAASuB,QAAQP,GAahB,OARGnB,aAAeA,YAAY2B,SAC7B9C,MAAM+C,QAAQ5B,YAAa,SAAS6B,GACnCL,OAAOC,QAAQI,EAAQnC,GAAImC,EAAQ1B,UACnC0B,EAAQ1B,SAAW,OAEpBH,iBAGMmB,EAASD,QAAQY,QAASX,EAASY,KAE3C,SAASC,cAAcb,GACtB,QAASc,KAAKC,aAEf,SAASC,mBAAmBhB,UAC3B,IAAIiB,YAAcjB,SAASD,QAAQkB,YAEnC,OAAOA,aAAeC,KAAK,UAAYD,YAAc,qBAEtD,SAASE,eAAenB,EAAUoB,GAC9BN,KAAKV,WACPP,eAAeiB,MAEbM,EACFN,KAAKO,OAAOD,GAEZN,KAAKQ,QAAQtB,GAIf,SAASK,OAAOtB,EAAKgB,EAASwB,GAC7B,IAAIvB,EAAWxC,KAAKgE,UAAUzC,EAAKvB,KAAKiE,YAAa1B,IACrDhB,EAAMiB,EAASjB,IACfgB,EAAUC,EAASD,QAEnB,IAAID,EAAMtC,KAAKkE,SACd1B,EACAG,SACAI,QACAR,EAAQY,MAAQ,KAAQZ,EAAQkB,YAAcD,mBAAqBH,cACnEM,iBAGDxD,KAAKgE,MAAM7B,GACVvB,GAAID,IAAOG,UACX2B,WAAW,IAGTL,EAAQY,SACW,IAAIiB,OAAO,OAAS7B,EAAQY,MAAQ,KACtCkB,KAAK9C,KACvBA,KAASA,EAAI+C,QAAQ,KAAO,IAAM,KACjC/B,EAAQY,MAAQ,KACfZ,EAAQf,SAAW,UAAY,IAChCV,IAAM,cAAgBwB,EAAIvB,IAG5BuB,EAAIM,WAAY,EAChBxB,UAAUkB,EAAIvB,IAAM,SAASwD,GAC5B/B,EAASY,KAAOmB,EAChBjC,EAAIqB,eAAenB,KAQrB,GAJGxC,KAAKwE,QACPxE,KAAKwE,OAAOC,KAAK,OAAQjC,EAAUF,EAAIoC,QAAQC,SAG5CpC,EAAQqC,WAAarC,EAAQqC,UAAUtC,GAAK,CAC/C,IAAIuC,EAAOhC,OAAOiC,QAAQxC,EAAIvB,GAAIQ,EAAKgB,EAAQf,UAE/C,IAAIe,EAAQY,QAAUZ,EAAQkB,YAC7B,IAAIsB,EAAS3E,GAAGyE,EAAM3D,UAAW,SAAS8D,IACzB,SAAbA,EAAIrD,MAAmBR,YAAYkD,KAAKQ,EAAKI,eAC/CF,EAAO9C,SACPK,EAAIiB,aAAeyB,KAQvB,OAFAjF,MAAMuC,GAECyB,EAAiBzB,EAAMA,EAAIoC,QAoDnC,OAlDA7B,OAAOqC,IAAMrC,OA8CbA,OAAOiC,QAAUxD,OACjBuB,OAAOC,QAAUb,OACjBY,OAAOsC,mBAAqBrE,IAAM,aAE3B+B","file":"../../request/script.js","sourcesContent":["define([\r\n\t'module',\r\n\t'./watch',\r\n\t'./util',\r\n\t'../_base/kernel',\r\n\t'../_base/array',\r\n\t'../_base/lang',\r\n\t'../on',\r\n\t'../dom',\r\n\t'../dom-construct',\r\n\t'../has',\r\n\t'../_base/window'/*=====,\r\n\t'../request',\r\n\t'../_base/declare' =====*/\r\n], function(module, watch, util, kernel, array, lang, on, dom, domConstruct, has, win/*=====, request, declare =====*/){\r\n\thas.add('script-readystatechange', function(global, document){\r\n\t\tvar script = document.createElement('script');\r\n\t\treturn typeof script['onreadystatechange'] !== 'undefined' &&\r\n\t\t\t(typeof global['opera'] === 'undefined' || global['opera'].toString() !== '[object Opera]');\r\n\t});\r\n\r\n\tvar mid = module.id.replace(/[\\/\\.\\-]/g, '_'),\r\n\t\tcounter = 0,\r\n\t\tloadEvent = has('script-readystatechange') ? 'readystatechange' : 'load',\r\n\t\treadyRegExp = /complete|loaded/,\r\n\t\tcallbacks = kernel.global[mid + '_callbacks'] = {},\r\n\t\tdeadScripts = [];\r\n\r\n\tfunction attach(id, url, frameDoc){\r\n\t\tvar doc = (frameDoc || win.doc),\r\n\t\t\telement = doc.createElement('script');\r\n\r\n\t\telement.type = 'text/javascript';\r\n\t\telement.src = url;\r\n\t\telement.id = id;\r\n\t\telement.async = true;\r\n\t\telement.charset = 'utf-8';\r\n\r\n\t\treturn doc.getElementsByTagName('head')[0].appendChild(element);\r\n\t}\r\n\r\n\tfunction remove(id, frameDoc, cleanup){\r\n\t\tdomConstruct.destroy(dom.byId(id, frameDoc));\r\n\r\n\t\tif(callbacks[id]){\r\n\t\t\tif(cleanup){\r\n\t\t\t\t// set callback to a function that deletes itself so requests that\r\n\t\t\t\t// are in-flight don't error out when returning and also\r\n\t\t\t\t// clean up after themselves\r\n\t\t\t\tcallbacks[id] = function(){\r\n\t\t\t\t\tdelete callbacks[id];\r\n\t\t\t\t};\r\n\t\t\t}else{\r\n\t\t\t\tdelete callbacks[id];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction _addDeadScript(dfd){\r\n\t\t// Be sure to check ioArgs because it can dynamically change in the dojox/io plugins.\r\n\t\t// See http://bugs.dojotoolkit.org/ticket/15890.\r\n\t\tvar options = dfd.response.options,\r\n\t\t\tframeDoc = options.ioArgs ? options.ioArgs.frameDoc : options.frameDoc;\r\n\r\n\t\tdeadScripts.push({ id: dfd.id, frameDoc: frameDoc });\r\n\r\n\t\tif(options.ioArgs){\r\n\t\t\toptions.ioArgs.frameDoc = null;\r\n\t\t}\r\n\t\toptions.frameDoc = null;\r\n\t}\r\n\r\n\tfunction canceler(dfd, response){\r\n\t\tif(dfd.canDelete){\r\n\t\t\t//For timeouts and cancels, remove the script element immediately to\r\n\t\t\t//avoid a response from it coming back later and causing trouble.\r\n\t\t\tscript._remove(dfd.id, response.options.frameDoc, true);\r\n\t\t}\r\n\t}\r\n\tfunction isValid(response){\r\n\t\t//Do script cleanup here. We wait for one inflight pass\r\n\t\t//to make sure we don't get any weird things by trying to remove a script\r\n\t\t//tag that is part of the call chain (IE 6 has been known to\r\n\t\t//crash in that case).\r\n\t\tif(deadScripts && deadScripts.length){\r\n\t\t\tarray.forEach(deadScripts, function(_script){\r\n\t\t\t\tscript._remove(_script.id, _script.frameDoc);\r\n\t\t\t\t_script.frameDoc = null;\r\n\t\t\t});\r\n\t\t\tdeadScripts = [];\r\n\t\t}\r\n\r\n\t\treturn response.options.jsonp ? !response.data : true;\r\n\t}\r\n\tfunction isReadyScript(response){\r\n\t\treturn !!this.scriptLoaded;\r\n\t}\r\n\tfunction isReadyCheckString(response){\r\n\t\tvar checkString = response.options.checkString;\r\n\r\n\t\treturn checkString && eval('typeof(' + checkString + ') !== \"undefined\"');\r\n\t}\r\n\tfunction handleResponse(response, error){\r\n\t\tif(this.canDelete){\r\n\t\t\t_addDeadScript(this);\r\n\t\t}\r\n\t\tif(error){\r\n\t\t\tthis.reject(error);\r\n\t\t}else{\r\n\t\t\tthis.resolve(response);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction script(url, options, returnDeferred){\r\n\t\tvar response = util.parseArgs(url, util.deepCopy({}, options));\r\n\t\turl = response.url;\r\n\t\toptions = response.options;\r\n\r\n\t\tvar dfd = util.deferred(\r\n\t\t\tresponse,\r\n\t\t\tcanceler,\r\n\t\t\tisValid,\r\n\t\t\toptions.jsonp ? null : (options.checkString ? isReadyCheckString : isReadyScript),\r\n\t\t\thandleResponse\r\n\t\t);\r\n\r\n\t\tlang.mixin(dfd, {\r\n\t\t\tid: mid + (counter++),\r\n\t\t\tcanDelete: false\r\n\t\t});\r\n\r\n\t\tif(options.jsonp){\r\n\t\t\tvar queryParameter = new RegExp('[?&]' + options.jsonp + '=');\r\n\t\t\tif(!queryParameter.test(url)){\r\n\t\t\t\turl += (~url.indexOf('?') ? '&' : '?') +\r\n\t\t\t\t\toptions.jsonp + '=' +\r\n\t\t\t\t\t(options.frameDoc ? 'parent.' : '') +\r\n\t\t\t\t\tmid + '_callbacks.' + dfd.id;\r\n\t\t\t}\r\n\r\n\t\t\tdfd.canDelete = true;\r\n\t\t\tcallbacks[dfd.id] = function(json){\r\n\t\t\t\tresponse.data = json;\r\n\t\t\t\tdfd.handleResponse(response);\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tif(util.notify){\r\n\t\t\tutil.notify.emit('send', response, dfd.promise.cancel);\r\n\t\t}\r\n\r\n\t\tif(!options.canAttach || options.canAttach(dfd)){\r\n\t\t\tvar node = script._attach(dfd.id, url, options.frameDoc);\r\n\r\n\t\t\tif(!options.jsonp && !options.checkString){\r\n\t\t\t\tvar handle = on(node, loadEvent, function(evt){\r\n\t\t\t\t\tif(evt.type === 'load' || readyRegExp.test(node.readyState)){\r\n\t\t\t\t\t\thandle.remove();\r\n\t\t\t\t\t\tdfd.scriptLoaded = evt;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\twatch(dfd);\r\n\r\n\t\treturn returnDeferred ? dfd : dfd.promise;\r\n\t}\r\n\tscript.get = script;\r\n\t/*=====\r\n\tscript = function(url, options){\r\n\t\t// summary:\r\n\t\t//\t\tSends a request using a script element with the given URL and options.\r\n\t\t// url: String\r\n\t\t//\t\tURL to request\r\n\t\t// options: dojo/request/script.__Options?\r\n\t\t//\t\tOptions for the request.\r\n\t\t// returns: dojo/request.__Promise\r\n\t};\r\n\tscript.__BaseOptions = declare(request.__BaseOptions, {\r\n\t\t// jsonp: String?\r\n\t\t//\t\tThe URL parameter name that indicates the JSONP callback string.\r\n\t\t//\t\tFor instance, when using Yahoo JSONP calls it is normally,\r\n\t\t//\t\tjsonp: \"callback\". For AOL JSONP calls it is normally\r\n\t\t//\t\tjsonp: \"c\".\r\n\t\t// checkString: String?\r\n\t\t//\t\tA string of JavaScript that when evaluated like so:\r\n\t\t//\t\t\"typeof(\" + checkString + \") != 'undefined'\"\r\n\t\t//\t\tbeing true means that the script fetched has been loaded.\r\n\t\t//\t\tDo not use this if doing a JSONP type of call (use `jsonp` instead).\r\n\t\t// frameDoc: Document?\r\n\t\t//\t\tThe Document object of a child iframe. If this is passed in, the script\r\n\t\t//\t\twill be attached to that document. This can be helpful in some comet long-polling\r\n\t\t//\t\tscenarios with Firefox and Opera.\r\n\t});\r\n\tscript.__MethodOptions = declare(null, {\r\n\t\t// method: String?\r\n\t\t//\t\tThis option is ignored. All requests using this transport are\r\n\t\t//\t\tGET requests.\r\n\t});\r\n\tscript.__Options = declare([script.__BaseOptions, script.__MethodOptions]);\r\n\r\n\tscript.get = function(url, options){\r\n\t\t// summary:\r\n\t\t//\t\tSend an HTTP GET request using a script element with the given URL and options.\r\n\t\t// url: String\r\n\t\t//\t\tURL to request\r\n\t\t// options: dojo/request/script.__BaseOptions?\r\n\t\t//\t\tOptions for the request.\r\n\t\t// returns: dojo/request.__Promise\r\n\t};\r\n\t=====*/\r\n\r\n\t// TODO: Remove in 2.0\r\n\tscript._attach = attach;\r\n\tscript._remove = remove;\r\n\tscript._callbacksProperty = mid + '_callbacks';\r\n\r\n\treturn script;\r\n});\r\n"]}